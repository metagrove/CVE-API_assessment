<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVE Vulnerabilities</title>
    <link rel="stylesheet" href="style.css">
   
</head>
<body>
    <h1>CVE Vulnerabilities List</h1>

    <div id="filters">
        <label for="cveIdFilter">CVE ID:</label>
        <input type="text" id="cveIdFilter" placeholder="e.g., CVE-2003-0001">
        
        <label for="yearFilter">Year:</label>
        <input type="number" id="yearFilter" min="1999" max="2099" placeholder="e.g., 2003">
        
        <label for="cvssMinScore">CVSS Min Score:</label>
        <input type="number" id="cvssMinScore" min="0" max="10" step="0.1">
        
        <label for="cvssMaxScore">CVSS Max Score:</label>
        <input type="number" id="cvssMaxScore" min="0" max="10" step="0.1">
        
        <button id="clearFilters">Clear Filters</button>
    </div>

    <div id="mainContent">
        <table id="cveTable">
            <thead>
                <tr>
                    <th>CVE ID</th>
                    <th>Identifier</th>
                    <th>Publish Date</th>
                    <th>Last Modified Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tableRows"></tbody>        
        </table>
        <div id="loading">Loading...</div>
        <div class="pagination">
            <div>
                <label for="pageSize">Results per page:</label>
                <select id="pageSize">
                    <option value="10">10</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div>
                <button id="prevPage">Previous</button>
                <span id="currentPage"></span>
                <button id="nextPage">Next</button>
            </div>
            <div id="totalRecords"></div>
        </div>
    </div>

    <div id="cveDetails">
        <h2 id="cveTitle"></h2>
        <p id="cveDescription"></p>
        <h3>CVSS V2 Metrics:</h3>
        <p><strong>Severity:</strong> <span id="cveSeverity"></span></p>
        <p><strong>Score:</strong> <span id="cveScore"></span></p>
        <p><strong>Vector String:</strong> <span id="cveVectorString"></span></p>
        <table id="cveMetricsTable">
            <tr>
                <th>Access Vector</th>
                <th>Access Complexity</th>
                <th>Authentication</th>
                <th>Confidentiality Impact</th>
                <th>Integrity Impact</th>
                <th>Availability Impact</th>
            </tr>
            <tr id="cveMetricsRow"></tr>
        </table>
        <h3>Scores:</h3>
        <p><strong>Exploitability Score:</strong> <span id="cveExploitabilityScore"></span></p>
        <p><strong>Impact Score:</strong> <span id="cveImpactScore"></span></p>
        <h3>CPE:</h3>
        <table id="cpeCriteriaTable">
            <tr>
                <th>Criteria</th>
                <th>Match Criteria ID</th>
                <th>Vulnerable</th>
            </tr>
        </table>
        <button id="backToList">Back to List</button>
    </div>

    <script>
    // Base URL of the API
    const apiUrl = 'https://services.nvd.nist.gov/rest/json/cves/2.0';

    // DOM Elements
    const tableBody = document.getElementById('tableRows');
    const pageSizeSelect = document.getElementById('pageSize');
    const totalRecordsDisplay = document.getElementById('totalRecords');
    const cveDetailsDiv = document.getElementById('cveDetails');
    const mainContentDiv = document.getElementById('mainContent');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const currentPageSpan = document.getElementById('currentPage');
    const backToListBtn = document.getElementById('backToList');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const cveIdFilterInput = document.getElementById('cveIdFilter');
    const yearFilterInput = document.getElementById('yearFilter');
    const cvssMinScoreInput = document.getElementById('cvssMinScore');
    const cvssMaxScoreInput = document.getElementById('cvssMaxScore');
    const loadingDiv = document.getElementById('loading');

    // Pagination state
    let currentPage = 1;
    let pageSize = 10;
    let totalRecords = 0;

    // Filter state
    let cveIdFilter = '';
    let yearFilter = '';
    let cvssMinScore = '';
    let cvssMaxScore = '';

    // Debounce function to limit API calls
    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Fetch CVE data from the API
    async function fetchCVEData(page, limit) {
        try {
            loadingDiv.style.display = 'block';
            let url = `${apiUrl}?startIndex=${(page - 1) * limit}&resultsPerPage=${limit}`;
            
            // Apply filters
            let params = [];

            if (cveIdFilter) {
                params.push(`cveId=${cveIdFilter}`);
            }

            if (yearFilter) {
                const startDate = `${yearFilter}-01-01T00:00:00.000`;
                const endDate = `${yearFilter}-12-31T23:59:59.999`;
                params.push(`pubStartDate=${startDate}&pubEndDate=${endDate}`);
            }

            if (cvssMinScore || cvssMaxScore) {
                let cvssFilter = 'cvssV2Metrics.baseScore:';
                if (cvssMinScore && cvssMaxScore) {
                    cvssFilter += `[${cvssMinScore} TO ${cvssMaxScore}]`;
                } else if (cvssMinScore) {
                    cvssFilter += `[${cvssMinScore} TO *]`;
                } else if (cvssMaxScore) {
                    cvssFilter += `[* TO ${cvssMaxScore}]`;
                }
                params.push(cvssFilter);
            } 

            if (params.length > 0) {
                url += '&' + params.join('&');
            }

            console.log('Fetching URL:', url); 

            const response = await fetch(url);
            const data = await response.json();
            populateTable(data.vulnerabilities);
            totalRecords = data.totalResults;
            totalRecordsDisplay.textContent = `Total Records: ${totalRecords}`;
            updatePagination();
        } catch (error) {
            console.error('Error fetching data:', error);
        } finally {
            loadingDiv.style.display = 'none';
        }
    }
    // Populate table with CVE data
    function populateTable(vulnerabilities) {
        tableBody.innerHTML = '';

        vulnerabilities.forEach(vuln => {
            const row = document.createElement('tr');
            row.classList.add('clickable-row');
            
            row.setAttribute('data-cve-id', vuln.cve.id);
            row.addEventListener('click', () => showCVEDetails(vuln.cve.id));

            row.innerHTML = `
                <td>${vuln.cve.id}</td>
                <td>${vuln.cve.sourceIdentifier}</td>
                <td>${formatDate(vuln.cve.published)}</td>
                <td>${formatDate(vuln.cve.lastModified)}</td>
                <td>${vuln.cve.vulnStatus}</td>
            `;

            tableBody.appendChild(row);
        });
    }

    // Format the date from the API response
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Show CVE details about the specific details of CVE
    async function showCVEDetails(cveId) {
        try {
            loadingDiv.style.display = 'block';
            const response = await fetch(`${apiUrl}?cveId=${cveId}`);
            const data = await response.json();
            const cve = data.vulnerabilities[0].cve;

            document.getElementById('cveTitle').textContent = cve.id;
            document.getElementById('cveDescription').textContent = cve.descriptions[0].value;
            
            const metrics = cve.metrics.cvssMetricV2[0];
            document.getElementById('cveSeverity').textContent = metrics.baseSeverity;
            document.getElementById('cveScore').textContent = metrics.cvssData.baseScore;
            document.getElementById('cveVectorString').textContent = metrics.cvssData.vectorString;

            const metricsRow = document.getElementById('cveMetricsRow');
            metricsRow.innerHTML = `
                <td>${metrics.cvssData.accessVector}</td>
                <td>${metrics.cvssData.accessComplexity}</td>
                <td>${metrics.cvssData.authentication}</td>
                <td>${metrics.cvssData.confidentialityImpact}</td>
                <td>${metrics.cvssData.integrityImpact}</td>
                <td>${metrics.cvssData.availabilityImpact}</td>
            `;

            document.getElementById('cveExploitabilityScore').textContent = metrics.exploitabilityScore;
            document.getElementById('cveImpactScore').textContent = metrics.impactScore;

            const cpeCriteriaTable = document.getElementById('cpeCriteriaTable');
            cpeCriteriaTable.innerHTML = '<tr><th>Criteria</th><th>Match Criteria ID</th><th>Vulnerable</th></tr>';
            if (cve.configurations && cve.configurations[0] && cve.configurations[0].nodes) {
                cve.configurations[0].nodes.forEach(node => {
                    if (node.cpeMatch) {
                        node.cpeMatch.forEach(cpe => {
                            const row = cpeCriteriaTable.insertRow();
                            row.insertCell().textContent = cpe.criteria;
                            row.insertCell().textContent = cpe.matchCriteriaId;
                            row.insertCell().textContent = cpe.vulnerable ? 'Yes' : 'No';
                        });
                    }
                });
            }

            cveDetailsDiv.style.display = 'block';
            mainContentDiv.style.display = 'none';
        } catch (error) {
            console.error('Error fetching CVE details:', error);
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    // Update pagination
    function updatePagination() {
        const totalPages = Math.ceil(totalRecords / pageSize);
        currentPageSpan.textContent = `Page ${currentPage} of ${totalPages}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
    }

    // Apply filters
    const applyFilters = debounce(() => {
        cveIdFilter = cveIdFilterInput.value;
        yearFilter = yearFilterInput.value;
        cvssMinScore = cvssMinScoreInput.value;
        cvssMaxScore = cvssMaxScoreInput.value;
        currentPage = 1;
        fetchCVEData(currentPage, pageSize);
    }, 300);

    // Clear filters
    function clearFilters() {
        cveIdFilterInput.value = '';
        yearFilterInput.value = '';
        cvssMinScoreInput.value = '';
        cvssMaxScoreInput.value = '';
        cveIdFilter = '';
        yearFilter = '';
        cvssMinScore = '';
        cvssMaxScore = '';
        currentPage = 1;
        fetchCVEData(currentPage, pageSize);
    }

    // Event listeners
    pageSizeSelect.addEventListener('change', () => {
        pageSize = parseInt(pageSizeSelect.value);
        currentPage = 1;
        fetchCVEData(currentPage, pageSize);
    });

    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            fetchCVEData(currentPage, pageSize);
        }
    });

    nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(totalRecords / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            fetchCVEData(currentPage, pageSize);
        }
    });

    backToListBtn.addEventListener('click', () => {
        cveDetailsDiv.style.display = 'none';
        mainContentDiv.style.display = 'block';
    });

    clearFiltersBtn.addEventListener('click', clearFilters);

    // Add event listeners for real-time filtering
    cveIdFilterInput.addEventListener('input', applyFilters);
    yearFilterInput.addEventListener('input', applyFilters);
    cvssMinScoreInput.addEventListener('input', applyFilters);
    cvssMaxScoreInput.addEventListener('input', applyFilters);

    // Initial fetch
    fetchCVEData(currentPage, pageSize);
    </script>
</body>
</html>
